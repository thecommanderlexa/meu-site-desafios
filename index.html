<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desafio Entre Amigos</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { Trophy, Plus, TrendingUp, Users, Calendar, Target, ChevronRight, Trash2, Check, X, Share2, Copy } = lucide;

        function ChallengeApp() {
          const [view, setView] = useState('home');
          const [challenges, setChallenges] = useState([]);
          const [currentChallenge, setCurrentChallenge] = useState(null);
          const [userName, setUserName] = useState('');
          const [isNameSet, setIsNameSet] = useState(false);
          const [loading, setLoading] = useState(true);
          const [showJoinModal, setShowJoinModal] = useState(false);

          useEffect(() => {
            loadData();
          }, []);

          const loadData = () => {
            try {
              const savedName = localStorage.getItem('user-name');
              if (savedName) {
                setUserName(savedName);
                setIsNameSet(true);
              }

              const savedChallenges = localStorage.getItem('all-challenges');
              if (savedChallenges) {
                setChallenges(JSON.parse(savedChallenges));
              }
            } catch (error) {
              console.log('Erro ao carregar dados:', error);
            } finally {
              setLoading(false);
            }
          };

          const saveChallenges = (newChallenges) => {
            setChallenges(newChallenges);
            localStorage.setItem('all-challenges', JSON.stringify(newChallenges));
          };

          const saveUserName = (name) => {
            setUserName(name);
            setIsNameSet(true);
            localStorage.setItem('user-name', name);
          };

          const joinChallengeByCode = (code) => {
            const challenge = challenges.find(c => c.id === code);
            if (challenge) {
              if (!challenge.participants.find(p => p.name === userName)) {
                const updatedChallenge = { ...challenge };
                updatedChallenge.participants.push({
                  name: userName,
                  progress: []
                });
                updatedChallenge.updates = [{
                  user: userName,
                  action: 'joined',
                  date: new Date().toISOString()
                }, ...(updatedChallenge.updates || [])];
                
                const newChallenges = challenges.map(c => c.id === code ? updatedChallenge : c);
                saveChallenges(newChallenges);
                setCurrentChallenge(updatedChallenge);
                setView('detail');
                setShowJoinModal(false);
                return true;
              } else {
                alert('Você já está neste desafio!');
                return false;
              }
            } else {
              alert('Código inválido! Verifique se digitou corretamente.');
              return false;
            }
          };

          if (loading) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center">
                <div className="text-white text-xl">Carregando...</div>
              </div>
            );
          }

          if (!isNameSet) {
            return <NameSetup onNameSet={saveUserName} />;
          }

          if (view === 'create') {
            return <CreateChallenge onBack={() => setView('home')} onSave={(challenge) => {
              const newChallenges = [...challenges, { ...challenge, id: Date.now().toString(), participants: [{ name: userName, progress: [] }], updates: [] }];
              saveChallenges(newChallenges);
              setView('home');
            }} />;
          }

          if (view === 'detail' && currentChallenge) {
            return <ChallengeDetail 
              challenge={currentChallenge} 
              userName={userName}
              onBack={() => {
                setView('home');
                setCurrentChallenge(null);
              }}
              onUpdate={(updatedChallenge) => {
                const newChallenges = challenges.map(c => c.id === updatedChallenge.id ? updatedChallenge : c);
                saveChallenges(newChallenges);
                setCurrentChallenge(updatedChallenge);
              }}
              onDelete={(id) => {
                const newChallenges = challenges.filter(c => c.id !== id);
                saveChallenges(newChallenges);
                setView('home');
                setCurrentChallenge(null);
              }}
            />;
          }

          return (
            <div className="min-h-screen bg-gradient-to-br from-purple-600 to-blue-600 p-4">
              <div className="max-w-4xl mx-auto">
                <div className="bg-white rounded-2xl shadow-2xl p-6 mb-6">
                  <div className="flex items-center justify-between mb-4">
                    <div>
                      <h1 className="text-3xl font-bold text-gray-800 flex items-center gap-2">
                        <lucide-icon name="trophy" className="text-yellow-500" size={32}></lucide-icon>
                        Desafio Entre Amigos
                      </h1>
                      <p className="text-gray-600 mt-1">Olá, {userName}! 👋</p>
                    </div>
                    <button
                      onClick={() => setView('create')}
                      className="bg-gradient-to-r from-purple-500 to-blue-500 text-white px-6 py-3 rounded-xl font-semibold hover:shadow-lg transition-all flex items-center gap-2"
                    >
                      <lucide-icon name="plus" size={20}></lucide-icon>
                      Criar Desafio
                    </button>
                  </div>
                  
                  <button
                    onClick={() => setShowJoinModal(true)}
                    className="w-full bg-green-500 text-white px-6 py-3 rounded-xl font-semibold hover:bg-green-600 transition-all flex items-center justify-center gap-2 mt-4"
                  >
                    <lucide-icon name="users" size={20}></lucide-icon>
                    Entrar em um Desafio
                  </button>
                </div>

                {showJoinModal && <JoinChallengeModal onClose={() => setShowJoinModal(false)} onJoin={joinChallengeByCode} />}

                <div className="grid gap-4">
                  {challenges.length === 0 ? (
                    <div className="bg-white rounded-2xl shadow-xl p-12 text-center">
                      <lucide-icon name="target" className="mx-auto text-gray-300 mb-4" size={64}></lucide-icon>
                      <h2 className="text-2xl font-bold text-gray-800 mb-2">Nenhum desafio ainda</h2>
                      <p className="text-gray-600 mb-6">Crie seu primeiro desafio e convide seus amigos!</p>
                      <button
                        onClick={() => setView('create')}
                        className="bg-gradient-to-r from-purple-500 to-blue-500 text-white px-8 py-3 rounded-xl font-semibold hover:shadow-lg transition-all"
                      >
                        Criar Primeiro Desafio
                      </button>
                    </div>
                  ) : (
                    challenges.map(challenge => (
                      <ChallengeCard
                        key={challenge.id}
                        challenge={challenge}
                        userName={userName}
                        onClick={() => {
                          setCurrentChallenge(challenge);
                          setView('detail');
                        }}
                      />
                    ))
                  )}
                </div>
              </div>
            </div>
          );
        }

        function JoinChallengeModal({ onClose, onJoin }) {
          const [code, setCode] = useState('');

          const handleJoin = () => {
            if (code.trim()) {
              onJoin(code.trim());
            }
          };

          return (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-6 max-w-md w-full">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-xl font-bold text-gray-800">Entrar em um Desafio</h3>
                  <button onClick={onClose} className="text-gray-500 hover:text-gray-700">
                    <lucide-icon name="x" size={24}></lucide-icon>
                  </button>
                </div>
                
                <p className="text-gray-600 mb-4">Digite o código do desafio que seu amigo compartilhou:</p>
                
                <input
                  type="text"
                  value={code}
                  onChange={(e) => setCode(e.target.value)}
                  placeholder="Cole o código aqui"
                  className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none mb-4"
                  onKeyPress={(e) => e.key === 'Enter' && handleJoin()}
                />
                
                <button
                  onClick={handleJoin}
                  disabled={!code.trim()}
                  className="w-full bg-gradient-to-r from-purple-500 to-blue-500 text-white px-6 py-3 rounded-xl font-semibold hover:shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  Entrar no Desafio
                </button>
              </div>
            </div>
          );
        }

        function NameSetup({ onNameSet }) {
          const [name, setName] = useState('');

          return (
            <div className="min-h-screen bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center p-4">
              <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                <lucide-icon name="trophy" className="mx-auto text-yellow-500 mb-4" size={64}></lucide-icon>
                <h1 className="text-3xl font-bold text-gray-800 text-center mb-2">Bem-vindo!</h1>
                <p className="text-gray-600 text-center mb-6">Como você gostaria de ser chamado?</p>
                <input
                  type="text"
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                  placeholder="Seu nome ou apelido"
                  className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none mb-4"
                  onKeyPress={(e) => e.key === 'Enter' && name.trim() && onNameSet(name.trim())}
                />
                <button
                  onClick={() => name.trim() && onNameSet(name.trim())}
                  disabled={!name.trim()}
                  className="w-full bg-gradient-to-r from-purple-500 to-blue-500 text-white px-6 py-3 rounded-xl font-semibold hover:shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  Começar
                </button>
              </div>
            </div>
          );
        }

        function CreateChallenge({ onBack, onSave }) {
          const [title, setTitle] = useState('');
          const [description, setDescription] = useState('');
          const [goal, setGoal] = useState('');
          const [unit, setUnit] = useState('');
          const [startDate, setStartDate] = useState('');
          const [endDate, setEndDate] = useState('');
          const [type, setType] = useState('competitive');

          const handleSubmit = () => {
            if (!title || !goal || !unit || !startDate || !endDate) return;

            onSave({
              title,
              description,
              goal: parseFloat(goal),
              unit,
              startDate,
              endDate,
              type,
              createdAt: new Date().toISOString()
            });
          };

          return (
            <div className="min-h-screen bg-gradient-to-br from-purple-600 to-blue-600 p-4">
              <div className="max-w-2xl mx-auto">
                <div className="bg-white rounded-2xl shadow-2xl p-6">
                  <button onClick={onBack} className="text-gray-600 hover:text-gray-800 mb-4 flex items-center gap-2">
                    ← Voltar
                  </button>
                  
                  <h2 className="text-2xl font-bold text-gray-800 mb-6">Criar Novo Desafio</h2>

                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Título do Desafio</label>
                      <input
                        type="text"
                        value={title}
                        onChange={(e) => setTitle(e.target.value)}
                        placeholder="Ex: Beber 8 copos de água por dia"
                        className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none"
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Descrição (opcional)</label>
                      <textarea
                        value={description}
                        onChange={(e) => setDescription(e.target.value)}
                        placeholder="Detalhes sobre o desafio..."
                        className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none"
                        rows="3"
                      />
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-2">Meta</label>
                        <input
                          type="number"
                          value={goal}
                          onChange={(e) => setGoal(e.target.value)}
                          placeholder="8"
                          className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none"
                        />
                      </div>

                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-2">Unidade</label>
                        <input
                          type="text"
                          value={unit}
                          onChange={(e) => setUnit(e.target.value)}
                          placeholder="copos de água"
                          className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none"
                        />
                      </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-2">Data de Início</label>
                        <input
                          type="date"
                          value={startDate}
                          onChange={(e) => setStartDate(e.target.value)}
                          className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none"
                        />
                      </div>

                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-2">Data de Término</label>
                        <input
                          type="date"
                          value={endDate}
                          onChange={(e) => setEndDate(e.target.value)}
                          className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none"
                        />
                      </div>
                    </div>

                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Tipo de Desafio</label>
                      <div className="grid grid-cols-2 gap-4">
                        <button
                          onClick={() => setType('competitive')}
                          className={`px-4 py-3 rounded-xl font-semibold transition-all ${
                            type === 'competitive'
                              ? 'bg-gradient-to-r from-purple-500 to-blue-500 text-white shadow-lg'
                              : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                          }`}
                        >
                          Competitivo
                        </button>
                        <button
                          onClick={() => setType('collaborative')}
                          className={`px-4 py-3 rounded-xl font-semibold transition-all ${
                            type === 'collaborative'
                              ? 'bg-gradient-to-r from-purple-500 to-blue-500 text-white shadow-lg'
                              : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                          }`}
                        >
                          Colaborativo
                        </button>
                      </div>
                    </div>

                    <button
                      onClick={handleSubmit}
                      disabled={!title || !goal || !unit || !startDate || !endDate}
                      className="w-full bg-gradient-to-r from-purple-500 to-blue-500 text-white px-6 py-4 rounded-xl font-semibold hover:shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed mt-6"
                    >
                      Criar Desafio
                    </button>
                  </div>
                </div>
              </div>
            </div>
          );
        }

        function ChallengeCard({ challenge, userName, onClick }) {
          const today = new Date();
          const start = new Date(challenge.startDate);
          const end = new Date(challenge.endDate);
          const daysRemaining = Math.ceil((end - today) / (1000 * 60 * 60 * 24));
          const status = today < start ? 'upcoming' : today > end ? 'ended' : 'active';

          const userParticipant = challenge.participants.find(p => p.name === userName);
          const totalProgress = userParticipant?.progress.reduce((sum, p) => sum + p.value, 0) || 0;
          const progressPercent = Math.min((totalProgress / challenge.goal) * 100, 100);

          return (
            <div 
              onClick={onClick}
              className="bg-white rounded-2xl shadow-xl p-6 hover:shadow-2xl transition-all cursor-pointer"
            >
              <div className="flex items-start justify-between mb-4">
                <div className="flex-1">
                  <h3 className="text-xl font-bold text-gray-800 mb-1">{challenge.title}</h3>
                  {challenge.description && (
                    <p className="text-gray-600 text-sm">{challenge.description}</p>
                  )}
                </div>
                <div className={`px-3 py-1 rounded-full text-xs font-semibold ${
                  status === 'active' ? 'bg-green-100 text-green-700' :
                  status === 'upcoming' ? 'bg-blue-100 text-blue-700' :
                  'bg-gray-100 text-gray-700'
                }`}>
                  {status === 'active' ? 'Ativo' : status === 'upcoming' ? 'Em breve' : 'Finalizado'}
                </div>
              </div>

              <div className="grid grid-cols-3 gap-4 mb-4">
                <div className="bg-purple-50 rounded-xl p-3">
                  <div className="flex items-center gap-2 text-purple-600 mb-1">
                    <lucide-icon name="target" size={16}></lucide-icon>
                    <span className="text-xs font-semibold">Meta</span>
                  </div>
                  <p className="text-lg font-bold text-gray-800">{challenge.goal} {challenge.unit}</p>
                </div>

                <div className="bg-blue-50 rounded-xl p-3">
                  <div className="flex items-center gap-2 text-blue-600 mb-1">
                    <lucide-icon name="calendar" size={16}></lucide-icon>
                    <span className="text-xs font-semibold">Tempo</span>
                  </div>
                  <p className="text-lg font-bold text-gray-800">
                    {status === 'active' ? `${daysRemaining}d` : status === 'upcoming' ? 'Em breve' : 'Fim'}
                  </p>
                </div>

                <div className="bg-green-50 rounded-xl p-3">
                  <div className="flex items-center gap-2 text-green-600 mb-1">
                    <lucide-icon name="users" size={16}></lucide-icon>
                    <span className="text-xs font-semibold">Pessoas</span>
                  </div>
                  <p className="text-lg font-bold text-gray-800">{challenge.participants.length}</p>
                </div>
              </div>

              <div className="mb-3">
                <div className="flex justify-between text-sm mb-2">
                  <span className="text-gray-600">Seu progresso</span>
                  <span className="font-bold text-gray-800">{totalProgress.toFixed(1)} / {challenge.goal}</span>
                </div>
                <div className="w-full bg-gray-200 rounded-full h-3">
                  <div 
                    className="bg-gradient-to-r from-purple-500 to-blue-500 h-3 rounded-full transition-all"
                    style={{ width: `${progressPercent}%` }}
                  />
                </div>
              </div>

              <div className="flex items-center justify-between text-sm text-gray-600">
                <span>{new Date(challenge.startDate).toLocaleDateString('pt-BR')} - {new Date(challenge.endDate).toLocaleDateString('pt-BR')}</span>
                <lucide-icon name="chevron-right" size={20} className="text-gray-400"></lucide-icon>
              </div>
            </div>
          );
        }

        function ChallengeDetail({ challenge, userName, onBack, onUpdate, onDelete }) {
          const [showAddProgress, setShowAddProgress] = useState(false);
          const [progressValue, setProgressValue] = useState('');
          const [showAddParticipant, setShowAddParticipant] = useState(false);
          const [newParticipantName, setNewParticipantName] = useState('');
          const [showShareModal, setShowShareModal] = useState(false);
          const [copied, setCopied] = useState(false);

          const userParticipant = challenge.participants.find(p => p.name === userName);
          const totalProgress = userParticipant?.progress.reduce((sum, p) => sum + p.value, 0) || 0;

          const inviteCode = challenge.id;

          const copyInviteCode = () => {
            navigator.clipboard.writeText(inviteCode);
            setCopied(true);
            setTimeout(() => setCopied(false), 2000);
          };

          const handleAddProgress = () => {
            if (!progressValue || parseFloat(progressValue) <= 0) return;

            const updatedChallenge = { ...challenge };
            const participantIndex = updatedChallenge.participants.findIndex(p => p.name === userName);
            
            if (participantIndex !== -1) {
              updatedChallenge.participants[participantIndex].progress.push({
                value: parseFloat(progressValue),
                date: new Date().toISOString()
              });

              updatedChallenge.updates = [{
                user: userName,
                action: 'added_progress',
                value: parseFloat(progressValue),
                date: new Date().toISOString()
              }, ...(updatedChallenge.updates || [])];

              onUpdate(updatedChallenge);
              setProgressValue('');
              setShowAddProgress(false);
            }
          };

          const handleAddParticipant = () => {
            if (!newParticipantName.trim()) return;

            const updatedChallenge = { ...challenge };
            if (!updatedChallenge.participants.find(p => p.name === newParticipantName.trim())) {
              updatedChallenge.participants.push({
                name: newParticipantName.trim(),
                progress: []
              });

              updatedChallenge.updates = [{
                user: newParticipantName.trim(),
                action: 'joined',
                date: new Date().toISOString()
              }, ...(updatedChallenge.updates || [])];

              onUpdate(updatedChallenge);
              setNewParticipantName('');
              setShowAddParticipant(false);
            }
          };

          const sortedParticipants = [...challenge.participants].sort((a, b) => {
            const totalA = a.progress.reduce((sum, p) => sum + p.value, 0);
            const totalB = b.progress.reduce((sum, p) => sum + p.value, 0);
            return totalB - totalA;
          });

          return (
            <div className="min-h-screen bg-gradient-to-br from-purple-600 to-blue-600 p-4">
              <div className="max-w-4xl mx-auto">
                <div className="bg-white rounded-2xl shadow-2xl p-6 mb-6">
                  <div className="flex items-center justify-between mb-4">
                    <button onClick={onBack} className="text-gray-600 hover:text-gray-800 flex items-center gap-2">
                      ← Voltar
                    </button>
                    <div className="flex items-center gap-2">
                      <button
                        onClick={() => setShowShareModal(true)}
                        className="bg-blue-500 text-white px-4 py-2 rounded-xl hover:bg-blue-600 transition-all flex items-center gap-2 text-sm font-semibold"
                      >
                        <lucide-icon name="share-2" size={18}></lucide-icon>
                        <span>Convidar</span>
                      </button>
                      <button
                        onClick={() => {
                          if (window.confirm('Tem certeza que deseja excluir este desafio?')) {
                            onDelete(challenge.id);
                          }
                        }}
                        className="text-red-500 hover:text-red-700 p-2"
                      